<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Test PJI</title>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <link rel="stylesheet" href="">
        <style>
            .bar:hover {
              fill: brown;
            }
          </style>
        <script src="https://d3js.org/d3.v4.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/d3-scale-radial.js"></script>
        
    </head>
    <body>
        <script>
            var continents;
            
            function pushDataIfNotEmpty(d, origins){
                if(d != ""){
                    origins.push(d);
                }
            }
            
            const w = 1300;
            const h = 700;
            const padding = 110;

        

            function displayPlot(data, year = null){
                var origins = [];
                const counts = new Map();
                const svg = d3.select("body")
                        .append("svg")
                        .attr("width", w)
                        .attr("height", h);
                data.forEach(function(d) { 
                    if(year == 2016){
                        pushDataIfNotEmpty(d.y2016, origins);
                    } else if (year == 2017){
                        pushDataIfNotEmpty(d.y2017, origins);
                    } else if (year == 2018) {
                        pushDataIfNotEmpty(d.y2018, origins);
                    } else if (year == 2019){
                        pushDataIfNotEmpty(d.y2019, origins);
                    } else {
                        pushDataIfNotEmpty(d.y2016, origins);
                        pushDataIfNotEmpty(d.y2017, origins);
                        pushDataIfNotEmpty(d.y2018, origins);
                        pushDataIfNotEmpty(d.y2019, origins);
                    }
                 });
                 origins.forEach(country => {
                    counts.set(country,counts.get(country) ? counts.get(country) + 1 : 1);
                 });
                
                
                const countValues = Array.from(counts.values())
                const countries = Array.from(counts.entries())

                d3.csv('../Countries-Continents.csv', function(data){
                    continents = new Map(data.map(d => [d.Country, d.Continent]));
                    countries.forEach(country => {
                        country.push(continents.get(country[0]));
                    });
                    countries.sort(function(a, b) {
                        return (a[2] < b[2]) ? -1 : (a[2] > b[2]) ? 1 : 0; 
                    });
                    const xScale = d3.scaleLinear()
                    .domain([0, countValues.length])
                    .range([padding, w - padding]);

                const yScale = d3.scaleSqrt()
                    .domain([1, d3.max(countValues)])
                    .range([padding, h - 2*padding]);

                const yScale2 = d3.scaleSqrt()
                    .domain([1,d3.max(countValues)])
                    .range([h - 2*padding, padding]);


                svg.selectAll("rect")
                    .data(countries)
                    .enter()
                    .append("rect")
                    .attr("x", (d, i) => xScale(i))
                    .attr("y", (d, i) => h - yScale(d[1]) - padding)
                    .attr("width", 10) 
                    .attr("height", (d, i) => yScale(d[1]))
                    .attr("fill", function(d) {
                        if(d[2] == 'Asia'){
                            return "yellow"
                        } else if(d[2] == 'Africa'){
                            return "plum"
                        } else if (d[2] == 'Europe'){
                            return "skyblue"
                        } else if (d[2] == 'North America'){
                            return "red"
                        } else if (d[2] == 'South America'){
                            return "orange"
                        } else if (d[2] == 'Oceania'){
                            return "navy"
                        }
                    })
                    .attr("class", "bar")
                    .append("title")
                    .text((d) => d[1]);

                const yAxis = d3.axisLeft(yScale2);

 
                svg.append("g")
                .attr("transform", "translate("+padding+",0)")
                .call(yAxis);

                svg.append("g")
                .selectAll("text")
                .data(countries)
                .enter()
                .append("text")
                .text((d) => d[0])
                .attr("x", (d, i) => h - padding)
                .attr("y", (d, i) => - xScale(i) -1)
                .attr("class", "barTitle")
                .attr("transform", "rotate(90)")
                .attr("font-size", "13");

                if(year){
                    year = year.toString();
                } else{
                    year = "2016-2019";
                }

                svg.append("g")
                .append("text")
                .text("Nombre de participants par pays à la conférence CHI (".concat(year).concat(")"))
                .attr("x", 300)
                .attr("y", 125)
                .attr("font-size", 20)
                .attr("text-decoration", "underline")
                });


                svg.append("circle").attr("cx",1100).attr("cy",60).attr("r", 6).style("fill", "plum")
                svg.append("text").attr("x", 1110).attr("y", 62).text("Africa").style("font-size", "15px").attr("alignment-baseline","middle")
                svg.append("circle").attr("cx",1100).attr("cy",80).attr("r", 6).style("fill", "yellow")
                svg.append("text").attr("x", 1110).attr("y", 82).text("Asia").style("font-size", "15px").attr("alignment-baseline","middle")
                svg.append("circle").attr("cx",1100).attr("cy",100).attr("r", 6).style("fill", "skyblue")
                svg.append("text").attr("x", 1110).attr("y", 102).text("Europe").style("font-size", "15px").attr("alignment-baseline","middle")
                svg.append("circle").attr("cx",1100).attr("cy",120).attr("r", 6).style("fill", "red")
                svg.append("text").attr("x", 1110).attr("y", 122).text("North America").style("font-size", "15px").attr("alignment-baseline","middle")
                svg.append("circle").attr("cx",1100).attr("cy",140).attr("r", 6).style("fill", "navy")
                svg.append("text").attr("x", 1110).attr("y", 142).text("Oceania").style("font-size", "15px").attr("alignment-baseline","middle")
                svg.append("circle").attr("cx",1100).attr("cy",160).attr("r", 6).style("fill", "orange")
                svg.append("text").attr("x", 1110).attr("y", 162).text("South America").style("font-size", "15px").attr("alignment-baseline","middle")
            }

            d3.csv('../chi-data.csv', displayPlot); 
            d3.csv('../chi-data.csv', (d) => displayPlot(d, 2016)); 
            d3.csv('../chi-data.csv', (d) => displayPlot(d, 2017)); 
            d3.csv('../chi-data.csv', (d) => displayPlot(d, 2018)); 
            d3.csv('../chi-data.csv', (d) => displayPlot(d, 2019)); 

            d3.csv('../flight_database_full.csv', function(data){
                var margin = {top: 10, right: 10, bottom: 10, left: 10},
                width = w - margin.left - margin.right,
                height = 1000 - margin.top - margin.bottom,
                innerRadius = 80,
                outerRadius = Math.min(width, height) / 2;   // the outerRadius goes from the middle of the SVG area to the border

                // append the svg object to the body of the page
                var svg = d3.select("body")
                .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform", "translate(" + width / 2 + "," + ( height/2+100 )+ ")"); // Add 100 on Y translation, cause upper bars are longer


                var carbon = new Map();
                var timeMap = new Map();
                var cpt = new Map();
                data.forEach(function(d){
                    var seconds = d.temps_vol.split(":");
                    seconds = parseInt(seconds[0]) + parseInt(seconds[1])/60 + parseInt(seconds[2]/3600)
                    cpt.set(d.arrivee, cpt.get(d.arrivee) ? cpt.get(d.arrivee) + 1 : 1);
                    carbon.set(d.arrivee, carbon.get(d.arrivee) ? (carbon.get(d.arrivee)*(cpt.get(d.arrivee)-1) + d.emission_CO2) / cpt.get(d.arrivee) : d.emission_CO2);
                    timeMap.set(d.arrivee, timeMap.get(d.arrivee) ? (timeMap.get(d.arrivee)*(cpt.get(d.arrivee)-1) + seconds) / cpt.get(d.arrivee) : seconds);
                });

                var time = Array.from(timeMap)
                
                var x = d3.scaleBand()
                .range([0, 2 * Math.PI])    // X axis goes from 0 to 2pi = all around the circle. If I stop at 1Pi, it will be around a half circle
                .align(0)                  // This does nothing ?
                .domain( Array.from(timeMap.keys()) ); // The domain of the X axis is the list of states.

                // Y scale
                var y = d3.scaleRadial()
                    .range([innerRadius, outerRadius])   // Domain will be define later.
                    .domain([0, Math.max(...timeMap.values())]); // Domain of Y is from 0 to the max seen in the data

                yAxis = g => g
                    .attr("text-anchor", "middle")
                    .call(g => g.append("text")
                        .attr("y", d => -y(y.ticks(5).pop()))
                        .attr("dy", "-1em")
                        .text("Temps de vol"))
                    .call(g => g.selectAll("g")
                    .data(y.ticks(5).slice(1))
                    .enter()
                    .append("g")
                        .attr("fill", "none")
                        .call(g => g.append("circle")
                            .attr("stroke", "#000")
                            .attr("stroke-opacity", 0.5)
                            .attr("r", y))
                        .call(g => g.append("text")
                            .attr("y", d => -y(d))
                            .attr("dy", "0.35em")
                            .attr("stroke", "#fff")
                            .attr("stroke-width", 5)
                            .text(y.tickFormat(5, "s"))
                        .clone(true)
                            .attr("fill", "#000")
                            .attr("stroke", "none")))
                    

                // Add bars
                svg.append("g")
                    .selectAll("path")
                    .data(time)
                    .enter()
                    .append("path")
                    .attr("fill", "#69b3a2")
                    .attr("d", d3.arc()     // imagine your doing a part of a donut plot
                        .innerRadius(innerRadius)
                        .outerRadius(function(d) { return y(d[1]); })
                        .startAngle(function(d) { return x(d[0]); })
                        .endAngle(function(d) { return x(d[0]) + x.bandwidth(); })
                        .padAngle(0.01)
                        .padRadius(innerRadius))
                    .append("title")
                    .text((d) => '0' + parseInt(d[1]) + ':' + (parseInt((d[1]%1)*60).toString().length == 1 ? '0' : '') + parseInt((d[1]%1)*60));

                svg.append("g")
                    .selectAll("g")
                    .data(time)
                    .enter()
                    .append("g")
                        .attr("text-anchor", function(d) { return (x(d[0]) + x.bandwidth() / 2 + Math.PI) % (2 * Math.PI) < Math.PI ? "end" : "start"; })
                        .attr("transform", function(d) { return "rotate(" + ((x(d[0]) + x.bandwidth() / 2) * 180 / Math.PI - 90) + ")"+"translate(" + (y(d[1])+10) + ",0)"; })
                    .append("text")
                        .text(function(d){return(d[0])})
                        .attr("transform", function(d) { return (x(d[0]) + x.bandwidth() / 2 + Math.PI) % (2 * Math.PI) < Math.PI ? "rotate(180)" : "rotate(0)"; })
                        .style("font-size", "11px")
                        .attr("alignment-baseline", "middle");
                
                svg.append("g")
                    .call(yAxis);


            });
        </script>
        <div id="my_dataviz"></div>


    </body>
</html> 